<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.babmukja.repository.mapper.RecipeMapper">

 	<resultMap id="recipeMap" type="recipe">
		<result column="mem_no" property="memNo" />
		<result column="mem_Nickname" property="memNickname" />
		<result column="recipe_no" property="recipeNo" />
		<result column="title" property="title" />
		<result column="content" property="content" />
		<result column="viewcnt" property="viewCnt" />
		<result column="rating" property="rating" />
		<result column="imgpath" property="imgPath" />
		<result column="likecnt" property="likeCnt" />
		<result column="scrapcnt" property="scrapCnt" />
		<result column="keyword_no" property="keywordNo" />
	</resultMap> 
	<resultMap id="keywordMap" type="keyword">
		<result column="keyword_no" property="keywordNo"/>
		<result column="keyword_map_no" property="keywordMapNo"/>
		<result column="keyword" property="keyword"/>
		<result column="cnt" property="cnt"/>
	</resultMap>
	
	<insert id="insertRecipe" parameterType="recipe" useGeneratedKeys="true" keyProperty="recipeNo">
		insert into tb_recipe(
					mem_no,title,content,imgpath)
					values(
					#{memNo},#{title},#{content},#{imgPath}
					)
	</insert>
	
	<select id="selectRecipe" resultMap="recipeMap">
		select m.mem_nickname,r.* from tb_member m,tb_recipe r
		 where m.mem_no = r.mem_no
		 order by regDate desc
	</select>
	
	<select id="selectRecipeByNo" parameterType="int" resultMap="recipeMap">
		select * from tb_recipe where recipe_no = #{recipeNo}
	</select>
	
	<update id="addViewCnt" parameterType="int">
		update tb_recipe
		   set viewcnt = viewcnt + 1
		 where recipe_no = #{recipeNo}
	</update>
	
	<update id="updateRecipe" parameterType="recipe">
		update tb_recipe
		   set title = #{title},
		       content = #{content}
		 where recipe_no = #{recipeNo}		   
	</update>
	
	<delete id="deleteRecipe" parameterType="int">
		delete 
		  from tb_recipe
		 where recipe_no = #{recipeNo}
	</delete>
	
	<!-- 레시피 상세 댓글 부분 -->
	
	<!-- 댓글 조회 -->
    <select id="selectReviewByNo" parameterType="page" resultType="RecipeReview">
    	select r.*, m.*
    	  from tb_recipe_review r
    	 inner join tb_member m
    	    on r.mem_no = m.mem_no
    	 where recipe_no = #{recipeNo}    	   
    	 order by recipe_review_no desc
    	 limit #{begin}, #{end}
    </select>   
    
    <!-- 전체 댓글 수 -->    
	<select id="selectReviewCount" parameterType="page" resultType="int">
		select count(*)
		  from tb_recipe_review v
		 inner join tb_recipe r
		    on v.recipe_no = r.recipe_no
		 where r.recipe_no = #{recipeNo}
	</select>
    
    <!-- 댓글 등록 -->
    <insert id="insertRecipeReview" parameterType="RecipeReview">    	
    	insert into tb_recipe_review (
			recipe_no, content, mem_no, score    	
    	) values (
    		#{recipeNo}, #{content}, #{memNo}, #{score}
     	)
    <selectKey keyProperty="recipeReviewNo" resultType="int" order="AFTER">
    	SELECT LAST_INSERT_ID()
  	</selectKey>
    </insert>    
    
    <!-- 댓글 등록될 때 레시피 평점 수정하기 -->
    <update id="updateRecipeRating" parameterType="int">
    	update tb_recipe
    	   set rating = (select avg(score) 
    	                   from tb_recipe_review 
    	                  where recipe_no = #{recipeNo})
    	 where recipe_no = #{recipeNo}
    </update>
    
    <!-- 댓글 수정 -->
    <update id="updateRecipeReview" parameterType="RecipeReview">
    	update tb_recipe_review
    	   set content = #{content}    	         
    	 where recipe_review_no = #{recipeReviewNo}
    </update>
    
    <!-- 댓글 하나만 가져오기 -->
    <select id="selectOneReviewByNo" parameterType="int" resultType="RecipeReview">
    	select r.*, m.* 
    	  from tb_recipe_review r
    	 inner join tb_member m
    	    on r.mem_no = m.mem_no
    	 where recipe_review_no = #{recipeReviewNo}
    </select> 
    
	<!-- 댓글 삭제 -->
	<delete id="deleteRecipeReview" parameterType="int">
		delete 
		  from tb_recipe_review
		 where recipe_review_no = #{recipeReviewNo}
	</delete>
	
	<!-- 레시피 키워드 시작 -->
	<select id="selectRecipeByKeyword" parameterType="int" resultMap="recipeMap">
		select r.*,m.mem_nickname
		  from tb_recipe r,tb_recipe_keyword k,tb_member m
		 where m.mem_no = r.mem_no
		   and r.recipe_no = k.recipe_no
		   and k.country = #{no} 
		       or k.situation = #{no} 
		       or k.level = #{no} 
		       or k.type = #{no}
		 order by r.recipe_no desc
	</select>
	
	<!-- 상위 키워드 출력 (키워드 사용 횟수 기준)-->
	<select id="selectKeywordMost" parameterType="String" resultMap="keywordMap">
		select #{string} as keywordNo, count(*) as cnt 
		  from tb_recipe_keyword
		 group by #{string}
		 order by cnt desc
		 limit 1
	</select>
	
	<select id="selectKeyword" resultMap="keywordMap">
		select *
		  from tb_keyword
	</select>
	
	<!-- 레시피에 키워드 삽입 -->
	<insert id="insertKeywordToRecipe" parameterType="RecipeKeywordCode">
		insert into tb_recipe_keyword (country,caution,situation,level,time,type,recipe_no) 
		values (#{country},#{caution},#{situation},#{level},#{time},#{type}, #{recipeNo})
	</insert>
	<select id="selectKeywordByNo" parameterType="int" resultType="RecipeKeywordName">
		select rk.recipe_no 'recipeNo',
			   (select keyword from tb_keyword where keyword_no = rk.country) 'country',
			   (select keyword from tb_keyword where keyword_no = rk.situation) 'situation',
			   rk.caution 'caution',
			   (select keyword from tb_keyword where keyword_no = rk.level) 'level',
			   (select keyword from tb_keyword where keyword_no = rk.time) 'time',
			   (select keyword from tb_keyword where keyword_no = rk.type) 'type'
  		from tb_recipe_keyword rk
  	   where rk.recipe_no = #{no}
	</select>
	

</mapper>